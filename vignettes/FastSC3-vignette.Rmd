---
title: "FastSC3 package manual"
author: "Vladimir Kiselev"
date: "`r Sys.Date()`"
output:
    BiocStyle::html_document:
        toc: true
vignette: >
  %\VignetteIndexEntry{SC3 package manual}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r knitr-options, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(fig.align = 'center', fig.width = 6, fig.height = 5, dev = 'png')
```

# Introduction

'FastSC3' is an extension of the 'SC3' package to very large datasets. While using some approximations, it allows a user to cluster the dataset without using the hybrid (SVM) strategy and to work on the total number of cells.

'FastSC3' depends on 'SC3' so that all the 'SC3' methods are accessible from 'FastSC3'.

# Quick Start

## `FastSC3` Input

The input for FastSC3 is an object of class scater. Here we will create it from the dataset ('treutlein') that comes with the package:

Macosko

```{r, message=FALSE, warning=FALSE}
library(scater)
library(FastSC3)
library(pheatmap)

# macosko <- readRDS("~/Dropbox/scRNASeq-public-datasets/macosko.rds")
# 
# cell_info <- data.frame(cell_id = colnames(macosko))
# cell_inds <- paste("Cell", 1:ncol(macosko), sep = "_")
# rownames(cell_info) <- cell_inds
# cell_exprs <- macosko
# colnames(cell_exprs) <- cell_inds
# pd <- new("AnnotatedDataFrame", data = cell_info)
# sceset <- newSCESet(countData = cell_exprs, phenoData = pd)
# sceset <- calculateQCMetrics(sceset)
# saveRDS(sceset, file = "~/Dropbox/scRNASeq-public-datasets/macosko_sceset.rds")

sceset <- readRDS("~/Dropbox/scRNASeq-public-datasets/macosko_sceset.rds")
gc()
ptm <- proc.time()
# prepare for k prediction
sceset <- sc3_prepare(sceset, svm.max = Inf)
# sceset <- sc3_estimate_k(sceset)
k <- 39
sceset <- sc3_set_ks(sceset, ks = k)
# prepare for M3Drop + LSH
sceset <- fsc3_get_hyperplanes(sceset, n_genes = 100)
sceset <- fsc3_get_signatures(sceset)
sceset <- fsc3_get_buckets(sceset, common_bits = 75)
sceset <- fsc3_get_buckets_signatures(sceset)

sceset <- fsc3_select_repr_cells(sceset)
# run normal SC3 pipeline on the selected cells
sceset <- sc3_calc_dists(sceset)
sceset <- sc3_calc_transfs(sceset)
sceset <- sc3_kmeans(sceset)
sceset <- sc3_calc_consens(sceset)
# infer cluster indexes from buckets
sceset <- fsc3_get_clusters(sceset, k = k)
# summarise results
sceset <- sc3_summarise_results(sceset, k = k)
mclust::adjustedRandIndex(sceset@sc3$results$clusters[,1], as.numeric(pData(sceset)[,1]))
proc.time() - ptm
gc()
```


Pollen

```{r, message=FALSE, warning=FALSE}
library(scater)
library(FastSC3)

# pollen2 <- readRDS("~/Dropbox/scRNASeq-public-datasets/pollen2.rds")
# cell_info <- data.frame(cell_id = colnames(pollen2))
# cell_inds <- paste("Cell", 1:ncol(pollen2), sep = "_")
# rownames(cell_info) <- cell_inds
# cell_exprs <- pollen2
# colnames(cell_exprs) <- cell_inds
# pd <- new("AnnotatedDataFrame", data = cell_info)
# sceset <- newSCESet(tpmData = cell_exprs, phenoData = pd)
# is_exprs(sceset) <- exprs(sceset) > 0
# sceset <- calculateQCMetrics(sceset)
# saveRDS(sceset, file = "~/Dropbox/scRNASeq-public-datasets/pollen2_sceset.rds")

sceset <- readRDS("~/Dropbox/scRNASeq-public-datasets/pollen2_sceset.rds")
# prepare for k prediction
sceset <- sc3_prepare(sceset)
# sceset <- sc3_estimate_k(sceset)
k <- 11
sceset <- sc3_set_ks(sceset, ks = k)
# prepare for M3Drop + LSH
sceset <- fsc3_get_hyperplanes(sceset, n_genes = 100)
sceset <- fsc3_get_signatures(sceset)
sceset <- fsc3_get_buckets(sceset, common_bits = 80)
sceset <- fsc3_get_buckets_signatures(sceset)
sceset <- fsc3_select_repr_cells(sceset)
# run normal SC3 pipeline on the selected cells
sceset <- sc3_calc_dists(sceset)
sceset <- sc3_calc_transfs(sceset)
sceset <- sc3_kmeans(sceset)
sceset <- sc3_calc_consens(sceset)
# infer cluster indexes from buckets
sceset <- fsc3_get_clusters(sceset, k = k)
# summarise results
sceset <- sc3_summarise_results(sceset, k = k)
mclust::adjustedRandIndex(sceset@sc3$results$clusters[,1], as.numeric(pData(sceset)[,1]))
```

Kolodziejczyk

```{r, message=FALSE, warning=FALSE}
library(scater)
library(FastSC3)

# kolodziejczyk <- readRDS("~/Dropbox/scRNASeq-public-datasets/kolodziejczyk.rds")
# cell_info <- data.frame(cell_id = colnames(kolodziejczyk))
# cell_inds <- paste("Cell", 1:ncol(kolodziejczyk), sep = "_")
# rownames(cell_info) <- cell_inds
# cell_exprs <- kolodziejczyk
# colnames(cell_exprs) <- cell_inds
# pd <- new("AnnotatedDataFrame", data = cell_info)
# sceset <- newSCESet(cpmData = cell_exprs, phenoData = pd)
# is_exprs(sceset) <- exprs(sceset) > 0
# sceset <- calculateQCMetrics(sceset)
# saveRDS(sceset, file = "~/Dropbox/scRNASeq-public-datasets/kolodziejczyk_sceset.rds")

sceset <- readRDS("~/Dropbox/scRNASeq-public-datasets/kolodziejczyk_sceset.rds")
# prepare for k prediction
sceset <- sc3_prepare(sceset)
# sceset <- sc3_estimate_k(sceset)
k <- 11
sceset <- sc3_set_ks(sceset, ks = k)
# prepare for M3Drop + LSH
sceset <- fsc3_get_hyperplanes(sceset, n_genes = 100)
sceset <- fsc3_get_signatures(sceset)
sceset <- fsc3_get_buckets(sceset, common_bits = 80)
sceset <- fsc3_select_repr_cells(sceset)
# run normal SC3 pipeline on the selected cells
sceset <- sc3_calc_dists(sceset)
sceset <- sc3_calc_transfs(sceset)
sceset <- sc3_kmeans(sceset)
sceset <- sc3_calc_consens(sceset)
# infer cluster indexes from buckets
sceset <- fsc3_get_clusters(sceset, k = k)
# summarise results
sceset <- sc3_summarise_results(sceset, k = k)
mclust::adjustedRandIndex(sceset@sc3$results$clusters[,1], as.numeric(pData(sceset)[,1]))
```


FJLT

```{r}
sceset <- readRDS("~/Dropbox/scRNASeq-public-datasets/pollen2_sceset.rds")
# prepare for k prediction
sceset <- sc3_prepare(sceset)
# sceset <- sc3_estimate_k(sceset)
k <- 11
sceset <- sc3_set_ks(sceset, ks = k)
# prepare for FJLT + LSH
sceset <- fsc3_fjlt(sceset)
sceset <- fsc3_get_signatures_fjlt(sceset)
sceset <- fsc3_get_buckets(sceset, common_bits = 80)
```



## `sc3_prepare`

```{r}
# Note that n.cores = 1 is required for compilation of this vignette.
# Please remove this parameter when running on your computer:
# sceset <- sc3_prepare(sceset)
sceset <- sc3_prepare(sceset, n.cores = 1)
sceset <- sc3_estimate_k(sceset)
sceset <- sc3_set_ks(sceset, ks = 5)
```

```{r}
sceset <- fsc3_fjlt(sceset)
pheatmap::pheatmap(sceset@sc3$fjlt)
```

```{r}
sceset <- sc3_calc_dists(sceset)
```

```{r}
sceset <- fsc3_calc_transfs(sceset)
```

```{r}
sceset <- fsc3_calc_eigenv(sceset)
```

```{r}
sceset <- sc3_kmeans(sceset)
```

```{r}
sceset <- sc3_calc_consens(sceset)
```

```{r}
sceset <- sc3_summarise_results(sceset, k = 5)
```


